<?php
namespace App\Http\Controllers\Admin;

use App\Exports\PaymentsExport; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å
use App\Models\User;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Redis;
use Maatwebsite\Excel\Facades\Excel;  // –ò–º–ø–æ—Ä—Ç —Ñ–∞—Å–∞–¥–∞ Excel
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Log;


class AdminPaymentController extends Controller
{
    public function exportPaymentsToExcel(Request $request)
    {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        $payments = json_decode($request->input('payments'), true);

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Excel
        return Excel::download(new PaymentsExport($payments), 'payments.xlsx');
    }
    public function index()
    {
        $admins = User::where('role_id', 1)->get();
        $currentAdmin = auth()->user();

        $clientName = $currentAdmin->name;
        $groupName = $currentAdmin->group;
        $groupNameParts = explode(':', str_replace(' ', '', $groupName));
        $groupName = $groupNameParts[1] ?? '';

        $payments = [];
        $summary = $this->summaryData($clientName, $groupName);

        try {
            Log::info('üì® –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ allTransactions', ['client' => $clientName, 'organiz' => $groupName]);
            $start = microtime(true);

            $response = Http::withBasicAuth('–ö—É—á–µ—Ä–µ–Ω–∫–æ–î', 'NitraPa$$@0@!')
                ->acceptJson()
                ->timeout(180)
                ->post('http://185.112.41.230/darvin_test/hs/lk/allTransactions', [
                    'client' => $clientName,
                    'organiz' => $groupName,
                ]);

            $duration = round(microtime(true) - $start, 2);
            Log::info("‚úÖ –û—Ç–≤–µ—Ç –æ—Ç allTransactions –∑–∞ {$duration} —Å–µ–∫. –°—Ç–∞—Ç—É—Å: " . $response->status());

            if ($response->successful()) {
                $raw = $response->body();
                $clean = str_replace(["\u{A0}", "\xC2\xA0", ";"], [" ", " ", ","], $raw);

                $pairs = json_decode($clean, true, 512, JSON_THROW_ON_ERROR);

                if (!is_array($pairs)) {
                    throw new \Exception("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON. –û–∂–∏–¥–∞–ª—Å—è –º–∞—Å—Å–∏–≤.");
                }

                foreach ($pairs as $line) {
                    if (!is_array($line)) continue;

                    $record = [];
                    foreach ($line as $key => $value) {
                        if (is_array($value)) {
                            $value = json_encode($value, JSON_UNESCAPED_UNICODE);
                        }
                        $record[trim($key)] = trim((string)$value);
                    }

                    if (!empty($record)) {
                        $payments[] = $record;
                    }
                }

            } else {
                Log::error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π: —Å—Ç–∞—Ç—É—Å ' . $response->status());
            }

        } catch (\JsonException $e) {
            Log::error('‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON: ' . $e->getMessage(), ['body' => $response->body()]);
        } catch (\Illuminate\Http\Client\ConnectionException $e) {
            Log::error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π: ' . $e->getMessage());
        }

        return view('admin.payments.index', compact('currentAdmin', 'admins', 'payments', 'summary'));
    }


//    public function index()
//    {
//        $admins = User::where('role_id', 1)->get();
//        $currentAdmin = auth()->user();
//
//        $clientName = $currentAdmin->name;
//        $groupName = $currentAdmin->group;
//        $groupNameParts = explode(':', str_replace(' ', '', $groupName));
//        $groupName = $groupNameParts[1] ?? '';
//
//        $cacheKey = "transactions_{$clientName}_{$groupName}";
//        $refresh = request()->has('refresh');
//
//        $payments = [];
//
//        $summary = $this->summaryData($clientName, $groupName);
//
//        if (!$refresh && Cache::has($cacheKey)) {
//            $payments = Cache::get($cacheKey);
//        } else {
//            try {
//                $response = Http::withBasicAuth('–ö—É—á–µ—Ä–µ–Ω–∫–æ–î', 'NitraPa$$@0@!')
//                    ->acceptJson()
//                    ->timeout(180)
//                    ->post('http://185.112.41.230/darvin_test/hs/lk/allTransactions', [
//                        'client' => $clientName,
//                        'organiz' => $groupName,
//                    ]);
//
//                if ($response->successful()) {
//                    $raw = $response->body();
//                    $clean = str_replace(["\u{A0}", "\xC2\xA0", ";"], [" ", " ", ","], $raw);
//
//                    $pairs = json_decode($clean, true, 512, JSON_THROW_ON_ERROR);
//
//                    if (!is_array($pairs)) {
//                        throw new \Exception("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON. –û–∂–∏–¥–∞–ª—Å—è –º–∞—Å—Å–∏–≤.");
//                    }
//
//                    foreach ($pairs as $line) {
//                        // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤ —Å –Ω—É–∂–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
//                        if (!is_array($line)) {
//                            continue;
//                        }
//
//                        $record = [];
//                        foreach ($line as $key => $value) {
//                            if (is_array($value)) {
//                                $value = json_encode($value, JSON_UNESCAPED_UNICODE); // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –≤–ª–æ–∂–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤
//                            }
//                            $record[trim($key)] = trim((string)$value);
//                        }
//
//                        if (!empty($record)) {
//                            $payments[] = $record;
//                        }
//                    }
//
//                    Cache::put($cacheKey, $payments, now()->addMinutes(10));
//                }
//                else {
//                    Log::error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π: —Å—Ç–∞—Ç—É—Å ' . $response->status());
//                }
//            } catch (\JsonException $e) {
//                Log::error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON: ' . $e->getMessage(), ['body' => $response->body()]);
//            } catch (\Illuminate\Http\Client\ConnectionException $e) {
//                Log::error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π: ' . $e->getMessage());
//            }
//        }
//        return view('admin.payments.index', compact('currentAdmin', 'admins', 'payments', 'summary'));
//
////        return view('admin.payments.index', compact('currentAdmin', 'admins', 'payments', 'summary'));
//    }

    public function summaryData($clientName = null, $groupName = null)
    {
        if (!$clientName || !$groupName) {
            $currentUser = auth()->user();
            $clientName = $currentUser->name;
            $groupParts = explode(':', str_replace(' ', '', $currentUser->group));
            $groupName = $groupParts[1] ?? '';
        }

        $summary = [
            'overpay' => 0,
            'debt' => 0,
            'delivered' => 0,
            'unallocated' => 0,
        ];

        try {
            $summaryResponse = Http::withBasicAuth('–ö—É—á–µ—Ä–µ–Ω–∫–æ–î', 'NitraPa$$@0@!')
                ->acceptJson()
                ->timeout(180)
                ->post('http://185.112.41.230/darvin_test/hs/lk/summaryData', [
                    'client' => $clientName,
                    'organiz' => $groupName,
                ]);

            $raw = $summaryResponse->body();
            Log::info('–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –æ—Ç summaryData:', ['body' => $raw]);

            if ($summaryResponse->successful()) {
                $decoded = json_decode($raw, true);

                if ($decoded === null) {
                    Log::error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º json_decode: ' . json_last_error_msg());
                    return $summary;
                }

                // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–π ‚Äî –¥–æ—Å—Ç–∞—ë–º –ø–æ–ª–µ 'body'
                if (isset($decoded['body']) && is_string($decoded['body'])) {
                    $inner = $decoded['body'];

                    // –£–¥–∞–ª—è–µ–º –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –≤—Å—ë –ø–æ–¥–æ–±–Ω–æ–µ
                    $inner = str_replace(["\u{A0}", "\xC2\xA0", "\xc2\xa0", "\xa0", "\u00A0"], ' ', $inner);
                    $inner = preg_replace('/\x{00A0}/u', ' ', $inner);

                    Log::info('–û—á–∏—â–µ–Ω–Ω–æ–µ —Ç–µ–ª–æ –ø–µ—Ä–µ–¥ decode body:', ['cleanBody' => $inner]);

                    $summaryData = json_decode($inner, true);

                    if (json_last_error() !== JSON_ERROR_NONE) {
                        Log::error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON –∏–∑ –ø–æ–ª—è body: ' . json_last_error_msg(), ['cleanBody' => $inner]);
                        return $summary;
                    }
                } else {
                    $summaryData = $decoded;
                }

                // –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞
                if ($summaryData && $summaryData['status'] === 'ok') {
                    foreach (['overpay', 'debt', 'delivered', 'unallocated'] as $key) {
                        $rawValue = $summaryData[$key] ?? '0';
                        $cleaned = preg_replace('/[^\d,.-]/u', '', $rawValue);
                        $summary[$key] = (float) str_replace(',', '.', $cleaned);
                    }
                } else {
                    Log::warning('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç summaryData –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' . json_encode($summaryData));
                }

            } else {
                Log::error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è summaryData: HTTP ' . $summaryResponse->status());
            }

        } catch (\Throwable $e) {
            Log::error('–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ summaryData: ' . $e->getMessage());
        }

        return $summary;
    }

}

